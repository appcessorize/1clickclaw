<% content_for :title, "#{@user.display_name} - Admin - ClawSaaS" %>

<div class="mb-8">
  <div class="flex items-center gap-4 mb-4">
    <%= link_to admin_users_path, class: "btn btn-ghost btn-sm" do %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back
    <% end %>
  </div>

  <div class="flex flex-wrap items-start justify-between gap-4">
    <div class="flex items-center gap-4">
      <div class="avatar placeholder">
        <div class="bg-primary text-primary-content w-16 rounded-full">
          <span class="text-2xl"><%= @user.display_name.first.upcase %></span>
        </div>
      </div>
      <div>
        <h1 class="text-3xl font-bold"><%= @user.display_name %></h1>
        <p class="text-base-content/70"><%= @user.email %></p>
      </div>
    </div>

    <div class="flex flex-wrap gap-2">
      <%= link_to "Edit", edit_admin_user_path(@user), class: "btn btn-outline btn-sm" %>
      <% if @user != current_user %>
        <%= button_to "Impersonate", impersonate_admin_user_path(@user), method: :post, class: "btn btn-warning btn-sm", data: { confirm: "Are you sure you want to impersonate this user?" } %>
        <% unless @user.subscribed? %>
          <%= button_to "Comp Subscription", comp_subscription_admin_user_path(@user), method: :post, class: "btn btn-success btn-sm", data: { confirm: "This will give the user an active subscription. Continue?" } %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<div class="grid lg:grid-cols-2 gap-6">
  <!-- User Details -->
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title mb-4">User Details</h2>

      <div class="space-y-4">
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">ID</span>
          <code class="text-sm"><%= @user.id %></code>
        </div>
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">Name</span>
          <span><%= @user.name || "Not set" %></span>
        </div>
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">Email</span>
          <span><%= @user.email %></span>
        </div>
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">Role</span>
          <span class="badge <%= @user.admin? ? 'badge-primary' : 'badge-ghost' %>"><%= @user.role.titleize %></span>
        </div>
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">Auth Provider</span>
          <span><%= @user.provider.present? ? @user.provider.titleize : "Email" %></span>
        </div>
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">Confirmed</span>
          <span><%= @user.confirmed_at.present? ? @user.confirmed_at.strftime("%b %d, %Y") : "No" %></span>
        </div>
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">Sign-in Count</span>
          <span><%= @user.sign_in_count %></span>
        </div>
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">Last Sign-in</span>
          <span><%= @user.current_sign_in_at&.strftime("%b %d, %Y %H:%M") || "Never" %></span>
        </div>
        <div class="flex justify-between py-2">
          <span class="text-base-content/70">Created</span>
          <span><%= @user.created_at.strftime("%b %d, %Y %H:%M") %></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Subscription Details -->
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title mb-4">Subscription Details</h2>

      <div class="space-y-4">
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">Status</span>
          <% badge_class = case @user.subscription_status.to_sym
             when :active then "badge-success"
             when :trialing then "badge-info"
             when :past_due then "badge-warning"
             when :canceled then "badge-error"
             else "badge-ghost"
             end %>
          <span class="badge <%= badge_class %>"><%= @user.subscription_status.titleize %></span>
        </div>
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">Stripe Customer ID</span>
          <% if @user.stripe_customer_id.present? %>
            <code class="text-sm"><%= @user.stripe_customer_id %></code>
          <% else %>
            <span class="text-base-content/50">Not set</span>
          <% end %>
        </div>
        <div class="flex justify-between py-2 border-b border-base-200">
          <span class="text-base-content/70">Stripe Subscription ID</span>
          <% if @user.stripe_subscription_id.present? %>
            <code class="text-sm"><%= @user.stripe_subscription_id %></code>
          <% else %>
            <span class="text-base-content/50">Not set</span>
          <% end %>
        </div>
        <div class="flex justify-between py-2">
          <span class="text-base-content/70">Trial Ends At</span>
          <span><%= @user.trial_ends_at&.strftime("%b %d, %Y %H:%M") || "N/A" %></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Subscription Events -->
<div class="card bg-base-100 shadow mt-6">
  <div class="card-body">
    <h2 class="card-title mb-4">Subscription Events</h2>

    <% if @subscription_events.any? %>
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>Event Type</th>
              <th>Stripe Event ID</th>
              <th>Processed At</th>
            </tr>
          </thead>
          <tbody>
            <% @subscription_events.each do |event| %>
              <tr>
                <td><%= event.event_type %></td>
                <td><code class="text-xs"><%= event.stripe_event_id %></code></td>
                <td><%= event.processed_at&.strftime("%b %d, %Y %H:%M") || "Pending" %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-base-content/50 text-center py-8">No subscription events</p>
    <% end %>
  </div>
</div>
